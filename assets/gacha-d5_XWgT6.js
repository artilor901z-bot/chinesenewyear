import"./modulepreload-polyfill-B5Qt9EMX.js";import{M as V,f as Be,B as D,F as w,b as B,U as K,V as y,g as $,H as Y,N as Fe,h as ke,i as P,j as C,k as _,l as H,R as Ne,m as Ge,n as Ue,o as Oe,p as Ve,q as He,r as Se,s as ze,t as We,W as Qe,S as je,u as $e,P as Ye,G as Xe,v as qe,w as me,x as X,y as q,z as J,D as be,E as Je,J as Ke,K as se,Q as ie,a as Ze,T as et,C as le}from"./three.module-BKgacnDn.js";const _e={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class U{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const tt=new Be(-1,1,1,-1,0,1);class st extends D{constructor(){super(),this.setAttribute("position",new w([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new w([0,2,0,0,2,0],2))}}const it=new st;class he{constructor(e){this._mesh=new V(it,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,tt)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class at extends U{constructor(e,t){super(),this.textureID=t!==void 0?t:"tDiffuse",e instanceof B?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=K.clone(e.uniforms),this.material=new B({name:e.name!==void 0?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new he(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class ve extends U{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){const s=e.getContext(),r=e.state;r.buffers.color.setMask(!1),r.buffers.depth.setMask(!1),r.buffers.color.setLocked(!0),r.buffers.depth.setLocked(!0);let n,l;this.inverse?(n=0,l=1):(n=1,l=0),r.buffers.stencil.setTest(!0),r.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),r.buffers.stencil.setFunc(s.ALWAYS,n,4294967295),r.buffers.stencil.setClear(l),r.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),r.buffers.color.setLocked(!1),r.buffers.depth.setLocked(!1),r.buffers.color.setMask(!0),r.buffers.depth.setMask(!0),r.buffers.stencil.setLocked(!1),r.buffers.stencil.setFunc(s.EQUAL,1,4294967295),r.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),r.buffers.stencil.setLocked(!0)}}class rt extends U{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class nt{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),t===void 0){const i=e.getSize(new y);this._width=i.width,this._height=i.height,t=new $(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Y}),t.texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new at(_e),this.copyPass.material.blending=Fe,this.clock=new ke}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let i=!1;for(let s=0,r=this.passes.length;s<r;s++){const n=this.passes[s];if(n.enabled!==!1){if(n.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),n.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),n.needsSwap){if(i){const l=this.renderer.getContext(),o=this.renderer.state.buffers.stencil;o.setFunc(l.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),o.setFunc(l.EQUAL,1,4294967295)}this.swapBuffers()}ve!==void 0&&(n instanceof ve?i=!0:n instanceof rt&&(i=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new y);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const i=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(i,s),this.renderTarget2.setSize(i,s);for(let r=0;r<this.passes.length;r++)this.passes[r].setSize(i,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class ot extends U{constructor(e,t,i=null,s=null,r=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=s,this.clearAlpha=r,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new P}render(e,t,i){const s=e.autoClear;e.autoClear=!1;let r,n;this.overrideMaterial!==null&&(n=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor)),this.clearAlpha!==null&&(r=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),this.clearDepth==!0&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),this.clear===!0&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor!==null&&e.setClearColor(this._oldClearColor),this.clearAlpha!==null&&e.setClearAlpha(r),this.overrideMaterial!==null&&(this.scene.overrideMaterial=n),e.autoClear=s}}const lt={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new P(0)},defaultOpacity:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 defaultColor;
		uniform float defaultOpacity;
		uniform float luminosityThreshold;
		uniform float smoothWidth;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );

			vec3 luma = vec3( 0.299, 0.587, 0.114 );

			float v = dot( texel.xyz, luma );

			vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

			float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

			gl_FragColor = mix( outputColor, texel, alpha );

		}`};class F extends U{constructor(e,t,i,s){super(),this.strength=t!==void 0?t:1,this.radius=i,this.threshold=s,this.resolution=e!==void 0?new y(e.x,e.y):new y(256,256),this.clearColor=new P(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let r=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);this.renderTargetBright=new $(r,n,{type:Y}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let f=0;f<this.nMips;f++){const b=new $(r,n,{type:Y});b.texture.name="UnrealBloomPass.h"+f,b.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(b);const j=new $(r,n,{type:Y});j.texture.name="UnrealBloomPass.v"+f,j.texture.generateMipmaps=!1,this.renderTargetsVertical.push(j),r=Math.round(r/2),n=Math.round(n/2)}const l=lt;this.highPassUniforms=K.clone(l.uniforms),this.highPassUniforms.luminosityThreshold.value=s,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new B({uniforms:this.highPassUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader}),this.separableBlurMaterials=[];const o=[3,5,7,9,11];r=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);for(let f=0;f<this.nMips;f++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(o[f])),this.separableBlurMaterials[f].uniforms.invSize.value=new y(1/r,1/n),r=Math.round(r/2),n=Math.round(n/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1;const d=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=d,this.bloomTintColors=[new C(1,1,1),new C(1,1,1),new C(1,1,1),new C(1,1,1),new C(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const c=_e;this.copyUniforms=K.clone(c.uniforms),this.blendMaterial=new B({uniforms:this.copyUniforms,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader,blending:_,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new P,this.oldClearAlpha=1,this.basic=new H,this.fsQuad=new he(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(e,t){let i=Math.round(e/2),s=Math.round(t/2);this.renderTargetBright.setSize(i,s);for(let r=0;r<this.nMips;r++)this.renderTargetsHorizontal[r].setSize(i,s),this.renderTargetsVertical[r].setSize(i,s),this.separableBlurMaterials[r].uniforms.invSize.value=new y(1/i,1/s),i=Math.round(i/2),s=Math.round(s/2)}render(e,t,i,s,r){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();const n=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),r&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=i.texture,e.setRenderTarget(null),e.clear(),this.fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this.fsQuad.render(e);let l=this.renderTargetBright;for(let o=0;o<this.nMips;o++)this.fsQuad.material=this.separableBlurMaterials[o],this.separableBlurMaterials[o].uniforms.colorTexture.value=l.texture,this.separableBlurMaterials[o].uniforms.direction.value=F.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[o]),e.clear(),this.fsQuad.render(e),this.separableBlurMaterials[o].uniforms.colorTexture.value=this.renderTargetsHorizontal[o].texture,this.separableBlurMaterials[o].uniforms.direction.value=F.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[o]),e.clear(),this.fsQuad.render(e),l=this.renderTargetsVertical[o];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,r&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(i),this.fsQuad.render(e)),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=n}getSeperableBlurMaterial(e){const t=[];for(let i=0;i<e;i++)t.push(.39894*Math.exp(-.5*i*i/(e*e))/e);return new B({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new y(.5,.5)},direction:{value:new y(.5,.5)},gaussianCoefficients:{value:t}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 invSize;
				uniform vec2 direction;
				uniform float gaussianCoefficients[KERNEL_RADIUS];

				void main() {
					float weightSum = gaussianCoefficients[0];
					vec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianCoefficients[i];
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(e){return new B({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}}F.BlurDirectionX=new y(1,0);F.BlurDirectionY=new y(0,1);const ht={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:`
		precision highp float;

		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`
	
		precision highp float;

		uniform sampler2D tDiffuse;

		#include <tonemapping_pars_fragment>
		#include <colorspace_pars_fragment>

		varying vec2 vUv;

		void main() {

			gl_FragColor = texture2D( tDiffuse, vUv );

			// tone mapping

			#ifdef LINEAR_TONE_MAPPING

				gl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );

			#elif defined( REINHARD_TONE_MAPPING )

				gl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );

			#elif defined( CINEON_TONE_MAPPING )

				gl_FragColor.rgb = OptimizedCineonToneMapping( gl_FragColor.rgb );

			#elif defined( ACES_FILMIC_TONE_MAPPING )

				gl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );

			#elif defined( AGX_TONE_MAPPING )

				gl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );

			#elif defined( NEUTRAL_TONE_MAPPING )

				gl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );

			#endif

			// color space

			#ifdef SRGB_TRANSFER

				gl_FragColor = sRGBTransferOETF( gl_FragColor );

			#endif

		}`};class ct extends U{constructor(){super();const e=ht;this.uniforms=K.clone(e.uniforms),this.material=new Ne({name:e.name,uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.fsQuad=new he(this.material),this._outputColorSpace=null,this._toneMapping=null}render(e,t,i){this.uniforms.tDiffuse.value=i.texture,this.uniforms.toneMappingExposure.value=e.toneMappingExposure,(this._outputColorSpace!==e.outputColorSpace||this._toneMapping!==e.toneMapping)&&(this._outputColorSpace=e.outputColorSpace,this._toneMapping=e.toneMapping,this.material.defines={},Ge.getTransfer(this._outputColorSpace)===Ue&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===Oe?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===Ve?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===He?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===Se?this.material.defines.ACES_FILMIC_TONE_MAPPING="":this._toneMapping===ze?this.material.defines.AGX_TONE_MAPPING="":this._toneMapping===We&&(this.material.defines.NEUTRAL_TONE_MAPPING=""),this.material.needsUpdate=!0),this.renderToScreen===!0?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}function Te(a,e,t,i="serif"){const s=document.createElement("canvas");s.width=s.height=e;const r=s.getContext("2d");r.clearRect(0,0,e,e),r.font=`bold ${e*.65}px ${i}`,r.textAlign="center",r.textBaseline="middle",r.fillStyle=t,r.shadowColor=t,r.shadowBlur=e*.05,r.fillText(a,e/2,e/2);const n=new le(s);return n.needsUpdate=!0,n}function O(a,e=.025,t=16766720,i=128){const s=new et(a,e,12,i),r=new H({color:t,transparent:!0,opacity:.85});return new V(s,r)}function ut(a,e,t,i){const s=Te(a,128,t,i),r=new X({map:s,transparent:!0,opacity:.7,blending:q,depthWrite:!1}),n=new J(r);return n.scale.setScalar(e),n}function dt(a,e="#1a0505",t="#FFD700"){const i=document.createElement("canvas");i.width=i.height=a;const s=i.getContext("2d"),r=a/2;s.clearRect(0,0,a,a),s.beginPath(),s.arc(r,r,r*.95,0,Math.PI*2),s.fillStyle=e,s.fill(),s.beginPath(),s.arc(r,r,r*.95,-Math.PI/2,Math.PI/2),s.fillStyle=t,s.fill(),s.beginPath(),s.arc(r,r*.5,r*.475,0,Math.PI*2),s.fillStyle=t,s.fill(),s.beginPath(),s.arc(r,r*1.5,r*.475,0,Math.PI*2),s.fillStyle=e,s.fill(),s.beginPath(),s.arc(r,r*.5,r*.12,0,Math.PI*2),s.fillStyle=e,s.fill(),s.beginPath(),s.arc(r,r*1.5,r*.12,0,Math.PI*2),s.fillStyle=t,s.fill(),s.beginPath(),s.arc(r,r,r*.95,0,Math.PI*2),s.strokeStyle=t,s.lineWidth=a*.012,s.shadowColor=t,s.shadowBlur=a*.02,s.stroke();const n=new le(i);return n.needsUpdate=!0,n}function ft(a,e,t="#FFD700"){const i=document.createElement("canvas");i.width=i.height=a;const s=i.getContext("2d");s.clearRect(0,0,a,a);const r=a*.1,n=a*.08,l=a*.6,o=a/2+(r+n);s.fillStyle=t,s.shadowColor=t,s.shadowBlur=a*.03;for(let c=0;c<3;c++){const f=o-c*(r+n);if(e[c]===1)s.fillRect((a-l)/2,f,l,r);else{const b=l*.4;s.fillRect((a-l)/2,f,b,r),s.fillRect(a/2+l*.1,f,b,r)}}const d=new le(i);return d.needsUpdate=!0,d}const pt=[{name:"乾",bits:[1,1,1]},{name:"坤",bits:[0,0,0]},{name:"离",bits:[1,0,1]},{name:"坎",bits:[0,1,0]},{name:"震",bits:[0,0,1]},{name:"巽",bits:[1,1,0]},{name:"艮",bits:[1,0,0]},{name:"兑",bits:[0,1,1]}],ye="福禄寿喜财吉";class gt{constructor(e,t="serif"){this.container=e,this.font=t,this.elapsed=0,this.pullProgress=0,this.tierColor=new P(1,.84,0),this.state="IDLE",this.burstActive=!1,this.burstTime=0,this.flashIntensity=0,this.cameraShakeAmt=0,this._baseBG=new P(13369344),this.renderer=new Qe({antialias:!0,powerPreference:"high-performance"}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.toneMapping=Se,this.renderer.toneMappingExposure=1,Object.assign(this.renderer.domElement.style,{position:"fixed",top:"0",left:"0",zIndex:"0",touchAction:"none"}),e.appendChild(this.renderer.domElement),this.scene=new je,this.scene.background=this._baseBG.clone(),this.scene.fog=new $e(8912896,.012),this.camera=new Ye(55,window.innerWidth/window.innerHeight,.1,100),this.camera.position.set(0,0,12),this.cameraBase=new C(0,0,12),this.cameraTarget=new C(0,0,12),this.composer=new nt(this.renderer),this.composer.addPass(new ot(this.scene,this.camera)),this.bloomPass=new F(new y(window.innerWidth,window.innerHeight),.5,.4,.55),this.composer.addPass(this.bloomPass),this.composer.addPass(new ct),this._createMagicCircle(),this._createBgParticles(),this._createSparkles(),this._createBurstSystem(),this._createFlash(),this._createExpandRings()}_createMagicCircle(){this.circleGroup=new Xe,this.scene.add(this.circleGroup),this.outerRing=O(3,.035,16766720),this.circleGroup.add(this.outerRing);const e=[];for(let n=0;n<12;n++){const l=Math.PI*2*n/12;e.push(Math.cos(l)*2.75,Math.sin(l)*2.75,0),e.push(Math.cos(l)*3,Math.sin(l)*3,0)}const t=new D;t.setAttribute("position",new w(e,3)),this.outerRing.add(new qe(t,new me({color:16766720,transparent:!0,opacity:.6}))),this.baguaSprites=[];for(let n=0;n<8;n++){const l=ft(128,pt[n].bits,"#FFD700"),o=new X({map:l,transparent:!0,opacity:.7,blending:q,depthWrite:!1}),d=new J(o);d.scale.set(.6,.6,1);const c=Math.PI*2*n/8;d.position.set(Math.cos(c)*3.5,Math.sin(c)*3.5,0),this.outerRing.add(d),this.baguaSprites.push(d)}this.middleRing=O(2.3,.025,16729156),this.middleRing.rotation.x=.3,this.circleGroup.add(this.middleRing);const i=O(2.1,.015,16737843,64);i.material.opacity=.4,this.middleRing.add(i);for(let n=0;n<8;n++){const l=new V(new be(.05,8,8),new H({color:16766720})),o=Math.PI*2*n/8;l.position.set(Math.cos(o)*2.3,Math.sin(o)*2.3,0),this.middleRing.add(l)}this.innerRing=O(1.6,.02,16753920),this.innerRing.rotation.x=-.2,this.innerRing.rotation.y=.3,this.circleGroup.add(this.innerRing);const s=dt(512,"#220808","#FFD700");this.taijiSprite=new J(new X({map:s,transparent:!0,blending:q,depthWrite:!1,opacity:.75})),this.taijiSprite.scale.set(2.8,2.8,1),this.circleGroup.add(this.taijiSprite);const r=Te("福",128,"#FFD700",this.font);this.centerChar=new J(new X({map:r,transparent:!0,opacity:.85,blending:q,depthWrite:!1})),this.centerChar.scale.setScalar(1.4),this.centerChar.position.z=.1,this.circleGroup.add(this.centerChar),this.orbitSprites=[];for(let n=0;n<ye.length;n++){const l=ut(ye[n],.4,"#FFD700",this.font);this.circleGroup.add(l),this.orbitSprites.push(l)}this.energyGlow=new V(new be(2.8,32,32),new H({color:16766720,transparent:!0,opacity:0,blending:_,depthWrite:!1,side:Je})),this.circleGroup.add(this.energyGlow),this.crackLines=[];for(let n=0;n<9;n++){const l=n*137.508,o=l%(Math.PI*2),d=[];for(let b=0;b<=4;b++){const pe=.5+2*(b/4),ge=b===0?0:Math.sin(l*b*3.7)*.15;d.push(Math.cos(o+ge)*pe,Math.sin(o+ge)*pe,.05)}const c=new D;c.setAttribute("position",new w(d,3));const f=new Ke(c,new me({color:16777200,transparent:!0,opacity:0}));this.circleGroup.add(f),this.crackLines.push(f)}}_updateMagicCircle(){const e=this.elapsed,t=this.pullProgress,i=1+t*8;this.outerRing.rotation.z=e*.15*i,this.middleRing.rotation.z=-e*.12*i,this.middleRing.rotation.x=.3+Math.sin(e*.4)*.1,this.innerRing.rotation.z=e*.1*i,this.innerRing.rotation.x=-.2+Math.cos(e*.35)*.12,this.innerRing.rotation.y=.3+Math.sin(e*.25)*.1,this.taijiSprite.material.rotation=-e*.3*i;const s=.9+.1*Math.sin(e*1.8);this.centerChar.scale.setScalar(1.4*s);for(let o=0;o<this.orbitSprites.length;o++){const d=Math.PI*2*o/this.orbitSprites.length+e*.15*i,c=2.7+Math.sin(e*1.5+o)*.15;this.orbitSprites[o].position.set(Math.cos(d)*c,Math.sin(d)*c,0)}const r=.12+t*.88;this.outerRing.material.opacity=.5*r,this.middleRing.material.opacity=.35*r,this.innerRing.material.opacity=.4*r,this.taijiSprite.material.opacity=(.35+t*.5)*r,this.centerChar.material.opacity=.4+t*.5;for(let o=0;o<this.orbitSprites.length;o++)this.orbitSprites[o].material.opacity=.25+t*.55;for(let o=0;o<this.baguaSprites.length;o++)this.baguaSprites[o].material.opacity=.2+t*.6;this.energyGlow.material.opacity=t*.18,this.energyGlow.material.color.copy(this.tierColor),this.energyGlow.scale.setScalar(1+t*.6);const n=t>.5?(t-.5)*2:0,l=Math.floor(3+n*6);for(let o=0;o<this.crackLines.length;o++)this.crackLines[o].material.opacity=o<l?n*.7:0;this.bloomPass.strength=.05+t*2.45,this.cameraTarget.z=12-t*2.5}_createBgParticles(){const t=new Float32Array(900);this._bgVel=new Float32Array(300*3),this._bgN=300;for(let s=0;s<300;s++)t[s*3]=(Math.random()-.5)*35,t[s*3+1]=(Math.random()-.5)*25,t[s*3+2]=(Math.random()-.5)*10-5,this._bgVel[s*3+1]=-.003-Math.random()*.005,this._bgVel[s*3]=(Math.random()-.5)*.002;const i=new D;i.setAttribute("position",new w(t,3)),this.bgPoints=new se(i,new ie({color:16766720,size:.12,transparent:!0,opacity:.15,blending:_,depthWrite:!1,sizeAttenuation:!0})),this.scene.add(this.bgPoints)}_updateBgParticles(){const e=this.bgPoints.geometry.attributes.position;for(let t=0;t<this._bgN;t++)e.array[t*3]+=this._bgVel[t*3]+Math.sin(this.elapsed*.3+t)*3e-4,e.array[t*3+1]+=this._bgVel[t*3+1],e.array[t*3+1]<-14&&(e.array[t*3+1]=14,e.array[t*3]=(Math.random()-.5)*35);e.needsUpdate=!0}_createSparkles(){this._sparkMax=150,this._sparkN=0,this._sparkLife=new Float32Array(150),this._sparkDecay=new Float32Array(150);const t=new Float32Array(150*3),i=new D;i.setAttribute("position",new w(t,3)),this.sparkPoints=new se(i,new ie({color:16766720,size:.15,transparent:!0,opacity:.35,blending:_,depthWrite:!1,sizeAttenuation:!0})),this.scene.add(this.sparkPoints)}spawnSparkle(){if(this._sparkN>=this._sparkMax)return;const e=this._sparkN++,t=Math.random()*Math.PI*2,i=2.5+Math.random()*1.5+this.pullProgress*.8,s=this.sparkPoints.geometry.attributes.position;s.array[e*3]=Math.cos(t)*i,s.array[e*3+1]=Math.sin(t)*i,s.array[e*3+2]=(Math.random()-.5)*.5,this._sparkLife[e]=.5+Math.random()*.5,this._sparkDecay[e]=.015+Math.random()*.01,s.needsUpdate=!0,this.sparkPoints.geometry.setDrawRange(0,this._sparkN)}_updateSparkles(){let e=0;const t=this.sparkPoints.geometry.attributes.position;for(let i=0;i<this._sparkN;i++)this._sparkLife[i]-=this._sparkDecay[i],this._sparkLife[i]>0&&(e!==i&&(t.array[e*3]=t.array[i*3],t.array[e*3+1]=t.array[i*3+1],t.array[e*3+2]=t.array[i*3+2],this._sparkLife[e]=this._sparkLife[i],this._sparkDecay[e]=this._sparkDecay[i]),e++);this._sparkN=e,t.needsUpdate=!0,this.sparkPoints.geometry.setDrawRange(0,this._sparkN)}_createBurstSystem(){this._burstMax=600,this._burstN=0,this._burstVel=new Float32Array(600*3),this._burstLife=new Float32Array(600),this._burstDecay=new Float32Array(600);const t=new Float32Array(600*3),i=new Float32Array(600*3),s=new D;s.setAttribute("position",new w(t,3)),s.setAttribute("color",new w(i,3)),this.burstPoints=new se(s,new ie({size:.22,vertexColors:!0,transparent:!0,opacity:.9,blending:_,depthWrite:!1,sizeAttenuation:!0})),this.burstPoints.visible=!1,this.scene.add(this.burstPoints)}triggerBurst(e){const t=Math.min(40+e.stars*14,this._burstMax);this._burstN=t;const[i,s,r]=e.burstRGB,n=this.burstPoints.geometry.attributes.position,l=this.burstPoints.geometry.attributes.color;for(let o=0;o<t;o++){n.array[o*3]=n.array[o*3+1]=n.array[o*3+2]=0;const d=Math.random()*Math.PI*2,c=Math.acos(2*Math.random()-1),f=2+Math.random()*7;this._burstVel[o*3]=Math.cos(d)*Math.sin(c)*f,this._burstVel[o*3+1]=Math.sin(d)*Math.sin(c)*f,this._burstVel[o*3+2]=Math.cos(c)*f*.4,l.array[o*3]=i/255,l.array[o*3+1]=s/255,l.array[o*3+2]=r/255,this._burstLife[o]=.8+Math.random()*.6,this._burstDecay[o]=.008+Math.random()*.012}n.needsUpdate=!0,l.needsUpdate=!0,this.burstPoints.visible=!0,this.burstPoints.geometry.setDrawRange(0,t),this.burstActive=!0,this.burstTime=0,this.flashIntensity=1,this.cameraShakeAmt=.35,this.circleGroup.visible=!1,this.triggerExpandRings(e.burstRGB)}_updateBurst(e){if(!this.burstActive)return;this.burstTime+=e;const t=this.burstPoints.geometry.attributes.position;let i=0;for(let s=0;s<this._burstN;s++)this._burstLife[s]<=0||(i++,this._burstVel[s*3]*=.975,this._burstVel[s*3+1]*=.975,this._burstVel[s*3+1]-=.025,this._burstVel[s*3+2]*=.975,t.array[s*3]+=this._burstVel[s*3]*e*60,t.array[s*3+1]+=this._burstVel[s*3+1]*e*60,t.array[s*3+2]+=this._burstVel[s*3+2]*e*60,this._burstLife[s]-=this._burstDecay[s]);t.needsUpdate=!0,this.burstPoints.material.opacity=i>0?.85:0,i===0&&(this.burstActive=!1,this.burstPoints.visible=!1)}_createFlash(){this.flashMesh=new V(new Ze(120,120),new H({color:16777215,transparent:!0,opacity:0,blending:_,depthWrite:!1,depthTest:!1})),this.flashMesh.renderOrder=999,this.scene.add(this.flashMesh)}_createExpandRings(){this.expandRings=[];for(let e=0;e<3;e++){const t=O(.1,.025,16766720);t.material.blending=_,t.material.depthWrite=!1,t.visible=!1,this.scene.add(t),this.expandRings.push({mesh:t,time:0,active:!1,delay:e*.15})}}triggerExpandRings(e){const t=new P(e[0]/255,e[1]/255,e[2]/255);for(const i of this.expandRings)i.active=!0,i.time=0,i.mesh.visible=!0,i.mesh.material.color.copy(t),i.mesh.scale.set(1,1,1)}_updateExpandRings(e){for(const t of this.expandRings){if(!t.active)continue;t.time+=e;const i=Math.max(0,t.time-t.delay);if(i>.7){t.active=!1,t.mesh.visible=!1;continue}const s=i/.7,r=.3+s*9;t.mesh.scale.set(r,r,1),t.mesh.material.opacity=(1-s)*.55}}resetToIdle(){this.state="IDLE",this.pullProgress=0,this.circleGroup.visible=!0,this.burstActive=!1,this.burstPoints.visible=!1,this.flashIntensity=0,this.cameraShakeAmt=0,this.cameraTarget.set(0,0,12),this.bloomPass.strength=.05,this.scene.background.copy(this._baseBG),this.scene.fog.color.set(8912896);for(const e of this.expandRings)e.active=!1,e.mesh.visible=!1}setDim(e){const t=1-e*.75,i=this._baseBG.clone().multiplyScalar(t);this.scene.background.copy(i),this.scene.fog.color.copy(i)}resize(){const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.composer.setSize(e,t),this.bloomPass.setSize(e,t)}update(e){if(this.elapsed+=e,this.circleGroup.visible&&this._updateMagicCircle(),this._updateBgParticles(),this._updateSparkles(),this._updateBurst(e),this._updateExpandRings(e),this.flashMesh.position.copy(this.camera.position),this.flashMesh.translateZ(-1.5),this.flashMesh.quaternion.copy(this.camera.quaternion),this.flashIntensity>0?(this.flashIntensity=Math.max(0,this.flashIntensity-e*2.8),this.flashMesh.material.opacity=this.flashIntensity*.85):this.flashMesh.material.opacity=0,this.cameraShakeAmt>.001){this.cameraShakeAmt*=.91;const t=this.cameraShakeAmt;this.camera.position.x=this.cameraTarget.x+(Math.random()-.5)*t,this.camera.position.y=this.cameraTarget.y+(Math.random()-.5)*t,this.camera.position.z=this.cameraTarget.z}else this.camera.position.lerp(this.cameraTarget,.06);if(this.pullProgress>.5&&this.state==="PULLING"){const t=(this.pullProgress-.5)*.18;this.camera.position.x+=(Math.random()-.5)*t,this.camera.position.y+=(Math.random()-.5)*t}this.composer.render()}dispose(){this.renderer.dispose(),this.composer.dispose(),this.renderer.domElement.parentElement&&this.renderer.domElement.parentElement.removeChild(this.renderer.domElement)}}const Z={pullThreshold:150,burstDuration:1.2,revealDuration:2},mt={一:{phrase:"一帆风顺",english:"Smooth sailing in all endeavors"},人:{phrase:"人寿年丰",english:"Long life and abundant harvests"},十:{phrase:"十全十美",english:"Perfection in every way"},大:{phrase:"大吉大利",english:"Great luck and great profit"},吉:{phrase:"吉祥如意",english:"Good fortune as you wish"},平:{phrase:"四季平安",english:"Peace through all four seasons"},安:{phrase:"岁岁平安",english:"Peace and safety year after year"},和:{phrase:"和气生财",english:"Harmony brings prosperity"},春:{phrase:"春风得意",english:"Success on the spring breeze"},利:{phrase:"开岁大利",english:"Great profit in the new year"},兴:{phrase:"兴旺发达",english:"Flourishing and thriving"},旺:{phrase:"人丁兴旺",english:"A growing and prosperous family"},发:{phrase:"恭喜发财",english:"Wishing you great prosperity"},金:{phrase:"金玉满堂",english:"Gold and jade fill the hall"},贵:{phrase:"荣华富贵",english:"Glory, splendor, and riches"},富:{phrase:"富贵有余",english:"Wealth and abundance to spare"},财:{phrase:"财源广进",english:"Wealth flowing from all directions"},寿:{phrase:"福寿双全",english:"Both blessings and longevity"},禄:{phrase:"高官厚禄",english:"High rank and generous reward"},喜:{phrase:"双喜临门",english:"Double happiness at the door"},龙:{phrase:"龙马精神",english:"The vigor of dragons and horses"},凤:{phrase:"龙凤呈祥",english:"Dragon and phoenix bring fortune"},福:{phrase:"福星高照",english:"The star of fortune shines bright"},玉:{phrase:"金玉良缘",english:"A golden and jade match"},宝:{phrase:"招财进宝",english:"Inviting wealth and treasures"},余:{phrase:"年年有余",english:"Abundance year after year"},丰:{phrase:"五谷丰登",english:"A bountiful harvest"},盛:{phrase:"繁荣昌盛",english:"Flourishing and prosperous"},隆:{phrase:"生意兴隆",english:"Business booming and thriving"},昌:{phrase:"繁荣昌盛",english:"Prosperity and flourishing"},进:{phrase:"招财进宝",english:"Welcoming wealth and treasure"},康:{phrase:"健康长寿",english:"Health and longevity"},宁:{phrase:"宁静致远",english:"Serenity leads to greatness"},泰:{phrase:"国泰民安",english:"A prosperous and peaceful nation"},顺:{phrase:"万事顺利",english:"Everything goes smoothly"},健:{phrase:"身体健康",english:"Good health and vitality"},乐:{phrase:"快乐无忧",english:"Joy and freedom from worry"},欢:{phrase:"合家欢乐",english:"Family happiness and joy"},庆:{phrase:"普天同庆",english:"All the world celebrates together"},禧:{phrase:"恭贺新禧",english:"Happy New Year greetings"},祺:{phrase:"吉祥安祺",english:"Auspicious blessings of peace"},嘉:{phrase:"嘉年华庆",english:"A grand festive celebration"},德:{phrase:"厚德载物",english:"Great virtue carries all things"},善:{phrase:"善气迎人",english:"Kindness welcomes all"},仁:{phrase:"仁者无敌",english:"The benevolent are invincible"},义:{phrase:"义薄云天",english:"Righteousness reaching the sky"},忠:{phrase:"忠义千秋",english:"Loyalty and honor through the ages"},信:{phrase:"信誉天下",english:"Trust and honor across the land"},孝:{phrase:"百善孝为先",english:"Filial piety is the root of virtue"},慧:{phrase:"聪慧过人",english:"Wisdom beyond measure"},恩:{phrase:"恩重如山",english:"Gratitude deep as the mountains"},爱:{phrase:"爱满人间",english:"Love fills the world"},合:{phrase:"百年好合",english:"A lifetime of harmony"},圆:{phrase:"花好月圆",english:"Blooming flowers and full moon"},满:{phrase:"满堂红光",english:"Red radiance fills the hall"},美:{phrase:"美满幸福",english:"Bliss and happiness"},馨:{phrase:"温馨如意",english:"Warm and fulfilling"},雅:{phrase:"典雅脱俗",english:"Elegance beyond the ordinary"},祥:{phrase:"吉祥如意",english:"Auspicious and as you wish"},瑞:{phrase:"瑞气盈门",english:"Auspicious energy at your door"},如:{phrase:"万事如意",english:"May everything go as you wish"},意:{phrase:"称心如意",english:"Everything to your heart's desire"},祝:{phrase:"祝福满满",english:"Overflowing with blessings"},运:{phrase:"鸿运当头",english:"Great fortune is upon you"},麟:{phrase:"凤毛麟角",english:"Rare and precious as a phoenix feather"},鹤:{phrase:"松鹤延年",english:"Pine and crane for longevity"},华:{phrase:"华夏瑞年",english:"An auspicious year for China"},成:{phrase:"马到成功",english:"Success upon arrival"},升:{phrase:"步步高升",english:"Rising higher with every step"},登:{phrase:"登峰造极",english:"Reaching the very peak"},高:{phrase:"高朋满座",english:"Distinguished guests fill every seat"}},Me=['"Zhi Mang Xing"','"Liu Jian Mao Cao"','"Ma Shan Zheng"','"TsangerZhoukeZhengdabangshu"','"hongleixingshu"','"qiantubifengshouxieti"','"峄山碑篆体"'],bt=[{name:"五福",nameEn:"Five Blessings",chars:"福禄寿喜财",r:255,g:45,b:45},{name:"财富",nameEn:"Wealth",chars:"财富贵发金玉宝余丰盛利旺",r:255,g:215,b:0},{name:"平安",nameEn:"Peace",chars:"安康宁泰和平顺健",r:0,g:255,b:159},{name:"喜庆",nameEn:"Joy",chars:"喜乐欢庆禧祺嘉春",r:255,g:120,b:80},{name:"德行",nameEn:"Virtue",chars:"德善仁义忠信孝慧恩",r:255,g:200,b:50},{name:"爱情",nameEn:"Love",chars:"爱合圆满美馨雅",r:255,g:130,b:180},{name:"吉祥",nameEn:"Auspicious",chars:"吉祥瑞如意祝运",r:180,g:255,b:80},{name:"神话",nameEn:"Mythical",chars:"龙凤麟鹤华",r:255,g:180,b:50},{name:"成就",nameEn:"Achievement",chars:"成升登高",r:80,g:220,b:255}],vt=[{stars:6,label:"天赐鸿福",labelEn:"Heavenly Fortune",categories:[0],color:"#FFD700",glow:"rgba(255,215,0,0.5)",burstRGB:[255,215,0]},{stars:5,label:"吉星高照",labelEn:"Auspicious Stars",categories:[7,8],color:"#FFA500",glow:"rgba(255,165,0,0.5)",burstRGB:[255,180,50]},{stars:4,label:"福泽绵长",labelEn:"Enduring Blessings",categories:[4,5],color:"#FF69B4",glow:"rgba(255,105,180,0.5)",burstRGB:[255,130,180]},{stars:3,label:"万事如意",labelEn:"All Wishes Fulfilled",categories:[2,6],color:"#00FF9F",glow:"rgba(0,255,159,0.5)",burstRGB:[0,255,159]},{stars:2,label:"迎春纳福",labelEn:"Welcoming Fortune",categories:[1,3],color:"#FF6644",glow:"rgba(255,102,68,0.5)",burstRGB:[255,120,80]}],ae=[3,7,15,25,50];function Q(a,e,t){return a<e?e:a>t?t:a}function Ce(a){return a<.5?2*a*a:-1+(4-2*a)*a}function yt(a){return a===0||a===1?a:Math.pow(2,-10*a)*Math.sin((a-.075)*(2*Math.PI)/.3)+1}const L=Me[Math.floor(Math.random()*Me.length)],Mt=document.getElementById("scene-container"),u=new gt(Mt,L);window.addEventListener("resize",()=>u.resize());function ne(){const a=Math.random()*100;let e=0,t=ae.length-1;for(let o=0;o<ae.length;o++)if(e+=ae[o],a<e){t=o;break}const i=vt[t],s=i.categories[Math.floor(Math.random()*i.categories.length)],r=bt[s],n=r.chars[Math.floor(Math.random()*r.chars.length)],l=mt[n]||{phrase:n+"运亨通",english:"Fortune and blessings upon you"};return{character:n,blessing:l,category:r,tier:i,tierIndex:t}}function xt(a){let e={};try{e=JSON.parse(localStorage.getItem("gacha_collection")||"{}")}catch{}const t=a.character;e[t]?e[t].count++:e[t]={count:1,firstTime:Date.now(),tierIndex:a.tierIndex};const i={totalDraws:0};try{Object.assign(i,JSON.parse(localStorage.getItem("gacha_stats")||"{}"))}catch{}i.totalDraws++,localStorage.setItem("gacha_collection",JSON.stringify(e)),localStorage.setItem("gacha_stats",JSON.stringify(i))}let h="IDLE",z=0,v=0,re=0,ce=0,p=0,g=null,ee=null,M=null,T=null,E=!1;document.getElementById("hud-overlay");const k=document.getElementById("hud-title"),N=document.getElementById("hud-hint"),x=document.getElementById("reveal-container"),ue=document.getElementById("card-overlay"),R=ue.querySelector(".card-container"),de=document.getElementById("btn-draw-again"),Ee=document.getElementById("back-link"),Pe=document.getElementById("home-link"),I=document.getElementById("btn-multi-pull"),te=document.getElementById("multi-overlay"),xe=document.getElementById("multi-grid"),wt=document.getElementById("btn-multi-again"),St=document.getElementById("btn-multi-single"),W=document.getElementById("multi-detail"),A=document.getElementById("detail-card");function m(a){h=a,ce=v,z=0,u.state=a,a==="IDLE"&&(p=0,g=null,T=null,E=!1,Ct(),we(),u.resetToIdle(),te.classList.remove("visible"),W.classList.remove("visible"),I.classList.remove("hidden"),k.classList.add("visible"),N.classList.add("visible")),a==="PULLING"&&(E||(g=ne()),T=g.tier,u.tierColor.set(T.burstRGB[0]/255,T.burstRGB[1]/255,T.burstRGB[2]/255),k.classList.remove("visible"),N.classList.remove("visible")),a==="BURST"&&(g||(g=ne()),T=g.tier,E||xt(g),u.triggerBurst(g.tier)),a==="REVEAL"&&(_t(g),u.bloomPass.strength=.7),a==="CARD_DISPLAY"&&(we(),E||Tt(g),u.setDim(.6),u.bloomPass.strength=.4)}function fe(){const a=p,e=v,t=.35;ee=()=>{const i=Q((v-e)/t,0,1);p=a*(1-yt(i)),i>=1&&(p=0,ee=null,h="IDLE",u.resetToIdle(),k.classList.add("visible"),N.classList.add("visible"))}}function Le(){if(h!=="IDLE")return;m("PULLING");const a=v,e=.6;M=()=>{const t=Q((v-a)/e,0,1);p=Ce(t),t>=1&&(p=1,M=null,m("BURST"))}}function _t(a){const e=a.tier;u.setDim(.3),x.innerHTML="",x.style.setProperty("--reveal-color",e.color);const t=document.createElement("div");t.className="reveal-stars",t.innerHTML=Array.from({length:e.stars},(o,d)=>`<span class="reveal-star" style="animation-delay:${1+d*.1}s">★</span>`).join(""),x.appendChild(t);const i=document.createElement("div");i.className="reveal-cat",i.textContent=`${a.category.name} · ${a.category.nameEn}`,x.appendChild(i);const s=document.createElement("div");s.className="reveal-char",s.textContent=a.character,s.style.fontFamily=`${L}, serif`,x.appendChild(s);const r=document.createElement("div");r.className="reveal-phrase",r.textContent=a.blessing.phrase,x.appendChild(r);const n=document.createElement("div");n.className="reveal-eng",n.textContent=a.blessing.english,x.appendChild(n);const l=document.createElement("div");l.className="reveal-tier",l.textContent=`${e.label} · ${e.labelEn}`,x.appendChild(l),x.classList.add("visible")}function we(){x.classList.remove("visible")}function Tt(a){const e=a.tier;R.style.setProperty("--card-color",e.color),R.style.setProperty("--card-glow",e.glow),R.style.setProperty("--card-font",`${L}, serif`),document.getElementById("card-stars").textContent="★".repeat(e.stars)+"☆".repeat(6-e.stars),document.getElementById("card-category").textContent=`${a.category.name} · ${a.category.nameEn}`;const t=document.getElementById("card-character");t.textContent=a.character,t.style.fontFamily=`${L}, serif`,document.getElementById("card-phrase").textContent=a.blessing.phrase,document.getElementById("card-english").textContent=a.blessing.english,document.getElementById("card-info").textContent=`${e.label} · ${e.labelEn}`,ue.classList.add("visible"),R.style.animation="none",R.offsetHeight,R.style.animation="",setTimeout(()=>{de.style.display="block",Ee.style.display="block",Pe.style.display="block"},600)}function Ct(){ue.classList.remove("visible"),de.style.display="none",Ee.style.display="none",Pe.style.display="none"}de.addEventListener("click",()=>m("IDLE"));function Et(){const a=[];for(let e=0;e<10;e++)a.push(ne());return a.sort((e,t)=>e.tierIndex-t.tierIndex),a}function Pt(a){let e={};try{e=JSON.parse(localStorage.getItem("gacha_collection")||"{}")}catch{}const t={totalDraws:0};try{Object.assign(t,JSON.parse(localStorage.getItem("gacha_stats")||"{}"))}catch{}for(const i of a){const s=i.character;e[s]?e[s].count++:e[s]={count:1,firstTime:Date.now(),tierIndex:i.tierIndex},t.totalDraws++}localStorage.setItem("gacha_collection",JSON.stringify(e)),localStorage.setItem("gacha_stats",JSON.stringify(t))}function Lt(a){xe.innerHTML="";for(let e=0;e<a.length;e++){const t=a[e],i=document.createElement("div");i.className="multi-card",i.style.setProperty("--mc-color",t.tier.color),i.style.setProperty("--mc-glow",t.tier.glow),i.style.animationDelay=`${e*.08}s`,i.innerHTML=`
            <div class="mc-stars">${"★".repeat(t.tier.stars)}</div>
            <div class="mc-char" style="font-family:${L},serif">${t.character}</div>
            <div class="mc-phrase">${t.blessing.phrase}</div>`,i.addEventListener("click",s=>{s.stopPropagation(),It(t)}),xe.appendChild(i)}te.classList.add("visible"),I.classList.add("hidden")}function Ie(){te.classList.remove("visible"),W.classList.remove("visible"),(h==="IDLE"||h==="CARD_DISPLAY")&&I.classList.remove("hidden")}function It(a){A.style.setProperty("--card-color",a.tier.color),A.style.setProperty("--card-glow",a.tier.glow),A.style.setProperty("--card-font",`${L}, serif`),document.getElementById("detail-stars").textContent="★".repeat(a.tier.stars)+"☆".repeat(6-a.tier.stars),document.getElementById("detail-category").textContent=`${a.category.name} · ${a.category.nameEn}`;const e=document.getElementById("detail-character");e.textContent=a.character,e.style.fontFamily=`${L}, serif`,document.getElementById("detail-phrase").textContent=a.blessing.phrase,document.getElementById("detail-english").textContent=a.blessing.english,document.getElementById("detail-info").textContent=`${a.tier.label} · ${a.tier.labelEn}`,A.style.animation="none",A.offsetHeight,A.style.animation="",W.classList.add("visible")}W.addEventListener("click",()=>W.classList.remove("visible"));function Re(){if(h!=="IDLE")return;E=!0;const a=Et();Pt(a),I.classList.add("hidden"),g=a[0],T=g.tier,m("PULLING");const e=v,t=.5;M=()=>{const i=Q((v-e)/t,0,1);p=Ce(i),i>=1&&(p=1,M=null,u.triggerBurst(g.tier),h="BURST",ce=v,z=0,u.state="BURST",setTimeout(()=>{Lt(a),h="CARD_DISPLAY",u.state="CARD_DISPLAY",u.setDim(.6)},900))}}I.addEventListener("click",()=>Re());wt.addEventListener("click",()=>{Ie(),m("IDLE"),setTimeout(()=>Re(),100)});St.addEventListener("click",()=>{Ie(),E=!1,m("IDLE")});function Rt(){h==="IDLE"&&!E?I.classList.remove("hidden"):h!=="IDLE"&&!te.classList.contains("visible")&&I.classList.add("hidden")}const S=u.renderer.domElement;let Ae=0,De=0,G=!1;S.addEventListener("touchstart",a=>{h==="IDLE"&&(Ae=a.touches[0].clientY,m("PULLING"),p=0)},{passive:!0});S.addEventListener("touchmove",a=>{if(h==="PULLING"&&!M){const e=Ae-a.touches[0].clientY;e>0&&(p=Q(e/Z.pullThreshold,0,1))}},{passive:!0});S.addEventListener("touchend",()=>{h==="PULLING"&&!M&&(p>=.95?m("BURST"):p>0?fe():(h="IDLE",u.resetToIdle(),k.classList.add("visible"),N.classList.add("visible")))},{passive:!0});S.addEventListener("mousedown",a=>{h==="IDLE"&&(De=a.clientY,G=!0,m("PULLING"),p=0)});S.addEventListener("mousemove",a=>{if(G&&h==="PULLING"&&!M){const e=De-a.clientY;e>0&&(p=Q(e/Z.pullThreshold,0,1))}});S.addEventListener("mouseup",()=>{G&&h==="PULLING"&&!M&&(p>=.95?m("BURST"):p>0?fe():(h="IDLE",u.resetToIdle(),k.classList.add("visible"),N.classList.add("visible"))),G=!1});S.addEventListener("mouseleave",()=>{G&&h==="PULLING"&&!M&&p>0&&fe(),G=!1});window.addEventListener("keydown",a=>{(a.code==="Space"||a.code==="ArrowUp"||a.code==="Enter")&&(a.preventDefault(),h==="IDLE"?Le():h==="CARD_DISPLAY"&&m("IDLE"))});S.addEventListener("wheel",a=>{a.deltaY<-30&&h==="IDLE"&&Le()},{passive:!0});function oe(a){re||(re=a);const e=v;v=(a-re)/1e3;const t=v-e;if(z=v-ce,ee&&ee(),M&&M(),u.pullProgress=p,t<=0||t>.1){requestAnimationFrame(oe);return}switch(h){case"IDLE":Math.random()<.12&&u.spawnSparkle(null);break;case"PULLING":Math.random()<.1+p*.5&&u.spawnSparkle(null);break;case"BURST":z>Z.burstDuration&&m("REVEAL");break;case"REVEAL":z>Z.revealDuration&&m("CARD_DISPLAY");break}u.update(t),Rt(),requestAnimationFrame(oe)}k.classList.add("visible");N.classList.add("visible");requestAnimationFrame(oe);
